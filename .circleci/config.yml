# Python CircleCI 2.1 configuration file
#
# Check https://circleci.com/docs/2.1/language-python/ for more details
#
version: 2.1
orbs:
  codecov: codecov/codecov@1.0.5
jobs:

  test_py38:
    working_directory: /home/circleci/src/CuBIDS
    docker:
      - image: continuumio/miniconda3
    steps:
      - checkout
      - run:
          name: Generate environment
          command:  |
            conda create -n py38_env python=3.8 pip -yq
            source activate py38_env
            pip install -e .[tests]
      - run:
          name: Run tests
          command:  |
            source activate py38_env
            py.test --cov-append --cov-report=xml --cov=cubids cubids
            mkdir /tmp/src/coverage
            mv /home/circleci/src/CuBIDS/.coverage /tmp/src/coverage/.coverage.py38

  test_py39:
    working_directory: /home/circleci/src/CuBIDS
    docker:
      - image: continuumio/miniconda3
    steps:
      - checkout
      - run:
          name: Generate environment
          command:  |
            conda create -n py39_env python=3.9 pip -yq
            source activate py39_env
            pip install -e .[tests]
      - run:
          name: Run tests
          command:  |
            source activate py39_env
            py.test --cov-append --cov-report=xml --cov=cubids cubids
            mkdir /tmp/src/coverage
            mv /home/circleci/src/CuBIDS/.coverage /tmp/src/coverage/.coverage.py39

  test_py310:
    working_directory: /home/circleci/src/CuBIDS
    docker:
      - image: continuumio/miniconda3
    steps:
      - checkout
      - run:
          name: Generate environment
          command:  |
            conda create -n py310_env python=3.10 pip -yq
            source activate py310_env
            pip install -e .[tests]
      - run:
          name: Run tests
          command:  |
            source activate py310_env
            py.test --cov-append --cov-report=xml --cov=cubids cubids
            mkdir /tmp/src/coverage
            mv /home/circleci/src/CuBIDS/.coverage /tmp/src/coverage/.coverage.py310

  test_py311:
    working_directory: /home/circleci/src/CuBIDS
    docker:
      - image: continuumio/miniconda3
    steps:
      - checkout
      - run:
          name: Generate environment
          command:  |
            conda create -n py311_env python=3.11 pip -yq
            source activate py311_env
            pip install -e .[tests]
      - run:
          name: Run tests
          command:  |
            source activate py311_env
            py.test --cov-append --cov-report=xml --cov=cubids cubids
            mkdir /tmp/src/coverage
            mv /home/circleci/src/CuBIDS/.coverage /tmp/src/coverage/.coverage.py311

  merge_coverage:
    working_directory: /home/circleci/src/CuBIDS
    docker:
      - image: continuumio/miniconda3
    steps:
      - attach_workspace:
          at: /tmp
      - checkout
      - run:
          name: Merge coverage files
          command: |
            apt-get update
            apt-get install -yqq curl
            source activate py37_env
            cd /tmp/src/coverage/
            coverage combine
            coverage xml
      - store_artifacts:
          path: /tmp/src/coverage
      - codecov/upload:
          file: /tmp/src/coverage/coverage.xml

workflows:
  version: 2.1
  run_tests:
    jobs:
      - test_py38
      - test_py39
      - test_py310
      - test_py311
      - merge_coverage:
          requires:
            - test_py38
            - test_py39
            - test_py310
            - test_py311
